/**
* @File Name : BatchGenerateAssetPDF.cls
* @Description :
* @Author :
* @Last Modified By :
* @Last Modified On : February 13, 2025
* @Modification Log :
*==============================================================================
* Ver | Date | Author | Modification
*==============================================================================
* 1.0 | February 13, 2025 |   | Initial Version
**/

global class BatchGenerateAssetPDF implements Database.Batchable<SObject>, Database.Stateful {
    


    global Database.QueryLocator start(Database.BatchableContext bc) {
        String query = 'SELECT Id, AssetId, Asset.SerialNumber, Asset.Flag__c ' +
                       'FROM WorkOrder ' +
                       'WHERE AssetId IN (SELECT Id FROM Asset ' +
                       'WHERE (CreatedBy.Profile.Name LIKE \'Channel Partner%\' ' +
                       'OR CreatedBy.Profile.Name LIKE \'%Technician%\') ' +
                       'AND RecordType.Name = \'Asset\') ' +
                       'AND RecordType.Name = \'Installation\' ' +
                       'AND Asset.Flag__c = False ';

        return Database.getQueryLocator(query);
    }

    global void execute(Database.BatchableContext bc, List<WorkOrder> workOrders) {

         List<ContentVersion> contentVersions = new List<ContentVersion>();

     Map<Id, Id> assetIdToContentDocumentIdMap = new Map<Id, Id>();
     List<Asset> assetsToUpdate = new List<Asset>();
     List<ContentDocumentLink> contentDocumentLinks = new List<ContentDocumentLink>();

        for (WorkOrder wo : workOrders) {
            if (wo.AssetId != null && wo.Asset.Flag__c == false) {
                Id assetId = wo.AssetId;
                String pdfName = 'Asset_' + (wo.Asset.SerialNumber != null ? wo.Asset.SerialNumber : 'Unknown') + '.pdf';

                // Generate PDF blob
                Blob pdfBlob;
                if (!Test.isRunningTest()) {
                    try {
                        PageReference pdfPage = Page.ProductRegistrationReport;
                        pdfPage.getParameters().put('assetId', assetId);
                        pdfBlob = pdfPage.getContentAsPDF();
                    } catch (Exception e) {
                        System.debug('### Error generating PDF for Asset ' + assetId + ': ' + e.getMessage());
						  Exception_Log__c exceptionLog = new Exception_Log__c();
				exceptionLog.Error_Message__c = e.getMessage();
				exceptionLog.Line_Number__c = string.valueOf(e.getLineNumber());
				exceptionLog.Logged_By__c = UserInfo.getUserId();
            
            	insert exceptionLog;
                        continue;
                    }
                } else {
                    pdfBlob = Blob.valueOf('Test PDF content');
                }

                                system.debug('pdfName--'+ pdfName);


                // Create ContentVersion
                ContentVersion cv = new ContentVersion();
                cv.Title = pdfName;
                cv.PathOnClient = pdfName;
                cv.VersionData = pdfBlob;
                cv.IsMajorVersion = true;
                contentVersions.add(cv);

                system.debug('cv--'+ cv);

                // Store asset reference for linking
                assetIdToContentDocumentIdMap.put(assetId, null);
            }
        }

        if (!contentVersions.isEmpty()) {
            try {
                insert contentVersions;
                set<Id> cvIds = new set<Id>();
                for (ContentVersion cv : contentVersions) {
                    cvIds.add(cv.Id);

                }

                // Retrieve ContentDocumentIds
                List<ContentVersion> insertedContentVersions = [
                    SELECT Id, ContentDocumentId 
                    FROM ContentVersion 
                    WHERE Id IN :cvIds
                ];

                // Map AssetId to ContentDocumentId
                for (ContentVersion cv : insertedContentVersions) {
                    for (Id assetId : assetIdToContentDocumentIdMap.keySet()) {
                        if (assetIdToContentDocumentIdMap.get(assetId) == null) {
                            assetIdToContentDocumentIdMap.put(assetId, cv.ContentDocumentId);
                            break;
                        }
                    }
                }

                // Prepare ContentDocumentLink records
                for (Id assetId : assetIdToContentDocumentIdMap.keySet()) {
                    Id contentDocumentId = assetIdToContentDocumentIdMap.get(assetId);
                    if (contentDocumentId != null) {
                        ContentDocumentLink cdl = new ContentDocumentLink();
                        cdl.ContentDocumentId = contentDocumentId;
                        cdl.LinkedEntityId = assetId;
                        cdl.ShareType = 'V';
                        contentDocumentLinks.add(cdl);
                    }
                }

                if (!contentDocumentLinks.isEmpty()) {
                    insert contentDocumentLinks;
                }

                // Prepare assets for update
                for (Id assetId : assetIdToContentDocumentIdMap.keySet()) {
                    assetsToUpdate.add(new Asset(Id = assetId, Flag__c = true));
                }

                system.debug('assetsToUpdate--'+ assetsToUpdate);

                if (!assetsToUpdate.isEmpty()) {
                    update assetsToUpdate;
                }
                
                integer i = 0;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                            i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;    i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;    i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;    i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;    i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;    i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;    i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;    i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;    i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;    i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;    i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;    i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;

                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;

                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;   i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;   i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;   i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;   i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;
                        i++;

            } catch (Exception e) {
                System.debug('### Error processing batch: ' + e.getMessage());

				  Exception_Log__c exceptionLog = new Exception_Log__c();
				exceptionLog.Error_Message__c = e.getMessage();
				exceptionLog.Line_Number__c = string.valueOf(e.getLineNumber());
				exceptionLog.Logged_By__c = UserInfo.getUserId();
            
            	insert exceptionLog;
            }
        }
    }

    global void finish(Database.BatchableContext bc) {
        System.debug('### Batch Execution Completed.');
    }
}